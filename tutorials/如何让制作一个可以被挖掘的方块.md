# 如何制作一个Shoveled Block

本文档创建于2023年1月19日，埃德蒙顿，加拿大

## 下载Example Mod

**重要**：如果你已经有自己的项目，则可以忽略这一步

[wzsjc2020/fabric-example-mod-1.19.2-prefab (github.com)](https://github.com/wzsjc2020/fabric-example-mod-1.19.2-prefab)

复制此仓库内所有的文件到本地



## 添加依赖包

```
build.gradle
```

```java
repositories {
	maven {
		url "https://maven.pkg.github.com/wzsjc2020/treasure-hunt-lib"
            credentials {
                username = "wzsjc2020"
                password = "see github 'how to use'"
            }
	}
}

dependencies {
	modImplementation ("com.wzssoft:treasurehuntlib:${"1.19-17.0.3"}")
}
```



## 添加一个第一个方块

### 创建方块

```
com.wzssoft.modid.block.common.ShoveledGrassBlock.java
```

```java
package com.wzssoft.modid.block.common;

import com.wzssoft.treasurehuntlib.block.common.AbstractShoveledBlock;

/**
 * added since 17.0.1
 */
public class ShoveledGrassBlock extends AbstractShoveledBlock {


    public ShoveledGrassBlock(Settings settings) {
        super(settings);
    }
}
```



### 注册方块物品

```
com.wzssoft.modid.block.MODIDBlocks.java
```

```java
public static final Block SHOVELED_GRASS_BLOCK = registerBlock("shoveled_grass_block",
        new ShoveledGrassBlock(FabricBlockSettings.of(Material.SOLID_ORGANIC).strength(0.6f).sounds(BlockSoundGroup.GRASS)));
```

```
com.wzssoft.modid.item.MODIDBlockItems.java
```

```java
public static final Item SHOVELED_GRASS_BLOCK_ITEM = registerBlockItem("shoveled_grass_block",
        new BlockItem(MODIDBlocks.SHOVELED_GRASS_BLOCK, new FabricItemSettings().group(MODIDItemGroups.ExtraCraft).rarity(Rarity.COMMON)));
```

重要：如果 itemgroup 报错的话需要自己新建一个

### 设置方块渲染

```
fabric.mod.json
```

```
"entrypoints": {
  "main": [
    "com.wzssoft.extracraft.ExtraCraftMod"
  ],
  "client": [
    "com.wzssoft.extracraft.ExtraCraftModClient"
  ]
},
```

如果你已经配置好client端则省略上面配置的过程



```
com.wzssoft.modid.MODIDClient.java
```

```java
public class MODIDClient implements ClientModInitializer {
    @Override
    public void onInitializeClient() {

        BlockRenderLayerMap.INSTANCE.putBlock(MODIDBlocks.SHOVELED_GRASS_BLOCK, RenderLayer.getCutout());
        ColorProviderRegistry.ITEM.register((stack, tintIndex) -> 0x5C9854, MODIDBlocks.SHOVELED_GRASS_BLOCK);
        ColorProviderRegistry.BLOCK.register(((state, world, pos, tintIndex) -> world.getColor(pos, BiomeColors.GRASS_COLOR)), MODIDBlocks.SHOVELED_GRASS_BLOCK);
    }
}
```



### 设置方块模型

这边就不演示了，如果想看教程可以参考一下

[tutorial:blockstate [Fabric Wiki\] (fabricmc.net)](https://fabricmc.net/wiki/tutorial:blockstate)

### 注册绑定方块

```
com.wzssoft.modid.MODIDMod.java
```

```java
@Override
public void onInitialize() {
...
    TreasureHuntLibRegister.registerTreasureEnchantmentEffectBlock(Blocks.GRASS_BLOCK,MODIDBlocks.SHOVELED_GRASS_BLOCK);
}
```

现在进入游戏如果一切都正常的话说明你都成功了

## 为方块添加更多的功能

### 添加随机刻

```
com.wzssoft.modid.block.common.ShoveledGrassBlock.java
```

```java
public class ShoveledGrassBlock extends AbstractShoveledBlock {

    public static final int MAX_MOISTURE = 5;
    public static final IntProperty MOISTURE = IntProperty.of("moisture", 0, MAX_MOISTURE);

    public ShoveledGrassBlock(Settings settings) {
        super(settings);
        this.setDefaultState(this.stateManager.getDefaultState().with(MOISTURE, 0));
    }

    @Override
    public boolean hasRandomTicks(BlockState state) {
        return true;
    }

    @Override
    public void randomTick(BlockState state, ServerWorld world, BlockPos pos, Random random) {
        int i = state.get(MOISTURE);
        if (this.isWaterNearBy(world, pos) || world.hasRain(pos.up())) {
            if (i < MAX_MOISTURE) {
                world.setBlockState(pos, (BlockState) state.with(MOISTURE, MAX_MOISTURE), Block.NOTIFY_LISTENERS);
            }
        } else if (i > 0) {
            world.setBlockState(pos, (BlockState) state.with(MOISTURE, i - 1), Block.NOTIFY_LISTENERS);
        } else if (this.hasAirOnTop(world, pos)) {

            //如果是没有花，且湿度为0则转换成默认方块
            this.setToOriginalBlock(world, pos);
        }
    }

    private boolean isWaterNearBy(World world, BlockPos pos) {
        for (BlockPos blockPos : BlockPos.iterate(pos.add(-2, 0, -2), pos.add(2, 1, 2))) {
            if (!world.getFluidState(blockPos).isIn(FluidTags.WATER)) continue;
            return true;
        }
        return false;
    }
    
        @Override
    protected void appendProperties(StateManager.Builder<Block, BlockState> builder) {
        builder.add(MOISTURE);
    }
}
```



### 添加自定义掉落物

如果你之前尝试挖掘一个方块会发现它报了一个null值错误，我们在这里更改它

```
com.wzssoft.modid.utils.MODIDLootTableModifier.java
```

```java
/**
 * added since 17.0.1
 *
 * @specialNote see all conditions at LootCondition.java
 * @specialNote this is only an example, do not copy this loot table to your own mod
 */
public class MODIDLootTableModifier {

    public static final Identifier GRASS_BLOCK_ID = new Identifier("minecraft", "blocks/grass_block");

    public static void registerModModifyLootTable() {

        LootTableEvents.REPLACE.register((resourceManager, lootManager, id, original, source) -> {
            if (GRASS_BLOCK_ID.equals(id)) {

                LootTable.Builder table = LootTable.builder();
                return table.build();
            }
            return original;
        });
    }
}
```



因为原版的json文件和 lootmodifier 无法满足此方块掉落物的生成条件，我们需要自定义一个复杂掉落

```
com.wzssoft.modid.utils.complexloottable.GrassBlockComplexLootTable.java
```

```java
/**
 * added since 17.0.1
 * @specialNote com.wzssoft.modid.utils.complexloottable.GrassBlockComplexLootTable.java
 */
public class GrassBlockComplexLootTable extends ComplexLootTableDataHelper {

    @Override
    public List<ItemStack> getDroppedStacks(ItemStack stack, World world, BlockState state, BlockPos pos, LivingEntity miner) {

        List<ItemStack> lootPools = new ArrayList<>();
        if (miner instanceof PlayerEntity player) {

            if (stack.hasEnchantments()) {
                NbtList list = stack.getEnchantments();


                for (int i = 0; i < list.size(); i++) {
                    NbtCompound nbtCompound = list.getCompound(i);

                    if (nbtCompound.getString("id").equals("minecraft:silk_touch")) {

                        //判断玩家手里的工具是不是带有精准采集附魔
                        lootPools.add(new ItemStack(Blocks.GRASS_BLOCK.asItem(), 1));
                        return lootPools;

                    } else if (nbtCompound.getString("id").equals("treasurehuntlib:treasure")) {

                        //判断玩家手里工具是否有Treasure附魔
                        if (isIn(10, world.random)) lootPools.add(new ItemStack(Items.COAL, isBetween(1, 2, world.random)));
                        if (isIn(1, world.random)) lootPools.add(new ItemStack(Items.DIAMOND, 1));

                        return lootPools;
                    }
                }
            }
        }
        //都不满足返回一个默认值
        lootPools.add(new ItemStack(Blocks.DIRT.asItem(), 1));
        return lootPools;
    }
}

```



```
com.wzssoft.modid.block.common.ShoveledGrassBlock.java
```

```java
...
    
@Override
public ComplexLootTableDataHelper getComplexLootTable() {
    return new GrassBlockComplexLootTable();
}

...
```

现在进入游戏就会发现它安装我们自定义的掉落物掉落了



## 其他更多功能

如果想实现在此方块上种自定义植物，请查看下一篇笔记